generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * -------------------- Enums --------------------
 */

enum WorkOrderType {
  PM
  CORRECTIVE
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AssetStatus {
  ACTIVE
  INACTIVE
}

enum LocationStatus {
  ACTIVE
  INACTIVE
}

enum FrequencyType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
  HOURS_BASED
  MILEAGE_BASED
}

enum WorkTaskStatus {
  ASSIGNED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  RETRYING
  CANCELLED
}

enum NotificationChannel {
  EMAIL
  PUSH
  SMS
  IN_APP
  WEBHOOK
}

enum NotificationAttemptStatus {
  PENDING
  SENT
  FAILED
}

enum LookupKind {
  DEPARTMENT
  ASSET_CATEGORY
  LOCATION_CATEGORY
  MATERIAL
}

/**
 * -------------------- Identity (Supabase Auth) --------------------
 */
/**
 * User.id == auth.users.id (Supabase UUID)
 * Supabase owns credentials, sessions, email verification.
 */
model User {
  id       String @id @map("id") @db.Uuid // Supabase auth.users.id
  email    String @unique @map("email")
  fullName String @map("full_name")
  username String @unique @map("username")

  // App-level flags (optional)
  isActive  Boolean @default(true) @map("is_active")
  isDeleted Boolean @default(false) @map("is_deleted")

  // Audit
  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Split profile (HR fields)
  profile UserProfile?

  // Site membership + RBAC
  userSites UserSite[]
  userRoles UserRole[]

  // Work order/task relations
  assignedTasks        WOTask[]              @relation("WorkOrderTaskAssignee")
  workOrderAssignments WorkOrderAssignment[] @relation("WorkOrderAssignmentUser")
  assignedWorkOrders   WorkOrder[]           @relation("WorkOrderAssignedUser")
  assetInCharge        Asset[]               @relation("AssetPersonInCharge")
  locationsInCharge    Location[]            @relation("LocationPersonInCharge")
  assignedByWorkOrders WorkOrderAssignment[] @relation("WorkOrderAssignedBy")
  removedByWorkOrders  WorkOrderAssignment[] @relation("WorkOrderRemovedBy")
  meterReadings        MeterReading[]        @relation("MeterReadingReadBy")
  notificationEvents   NotificationEvent[]

  @@index([createdAt])
  @@index([updatedAt])
  @@map("user")
}

model UserProfile {
  id     String @id @default(uuid()) @map("id") @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  title          String? @map("title")
  employeeCode   String? @map("employee_code")
  phone          String? @map("phone")
  phoneAlt       String? @map("phone_alt")
  country        String? @map("country")
  skills         String? @map("skills")
  certifications String? @map("certifications")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([employeeCode])
  @@map("user_profile")
}

model Site {
  id       String  @id @default(uuid()) @map("id") @db.Uuid
  name     String  @unique @map("name")
  location String  @map("location")
  isActive Boolean @default(true) @map("is_active")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  userSites UserSite[]

  // RBAC per site (custom roles per site)
  roles     Role[]
  userRoles UserRole[]

  // Domain
  lookups     Lookup[]
  locations   Location[]
  assets      Asset[]
  pmSchedules PMSchedule[]
  workOrders  WorkOrder[]

  notificationEvents NotificationEvent[]

  @@index([name])
  @@index([location])
  @@map("site")
}

model UserSite {
  id     String @id @default(uuid()) @map("id") @db.Uuid
  siteId String @map("site_id") @db.Uuid
  userId String @map("user_id") @db.Uuid

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([siteId, userId])
  @@index([siteId])
  @@index([userId])
  @@map("user_site")
}

/**
 * -------------------- RBAC (CUSTOM PER SITE) --------------------
 */

model Role {
  id          String  @id @default(uuid()) @map("id") @db.Uuid
  siteId      String  @map("site_id") @db.Uuid
  name        String  @map("name")
  code        String  @map("code")
  description String? @map("description")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  // Custom roles per site
  @@unique([siteId, code])
  @@unique([siteId, name])
  @@index([siteId])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("role")
}

// Permissions are typically global (shared catalog across sites).
// If later you need per-site permissions, add siteId here and adjust uniques.
model Permission {
  id          String  @id @default(uuid()) @map("id") @db.Uuid
  name        String  @map("name")
  code        String  @unique @map("code")
  description String? @map("description")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  rolePermissions RolePermission[]

  @@index([name])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("permission")
}

model UserRole {
  id     String @id @default(uuid()) @map("id") @db.Uuid
  siteId String @map("site_id") @db.Uuid
  userId String @map("user_id") @db.Uuid
  roleId String @map("role_id") @db.Uuid

  createdById String?  @map("created_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // IMPORTANT: Ensure in service layer that UserRole.siteId == Role.siteId.
  @@unique([siteId, userId, roleId])
  @@index([siteId])
  @@index([userId])
  @@index([roleId])
  @@index([createdAt])
  @@map("user_role")
}

model RolePermission {
  id           String @id @default(uuid()) @map("id") @db.Uuid
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  createdById String?  @map("created_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@index([createdAt])
  @@map("role_permission")
}

/**
 * -------------------- Lookup (Master Data) --------------------
 */

model Lookup {
  id          String     @id @default(uuid()) @map("id") @db.Uuid
  siteId      String     @map("site_id") @db.Uuid
  kind        LookupKind @map("kind")
  parentId    String?    @map("parent_id") @db.Uuid
  name        String     @map("name")
  code        String?    @map("code")
  description String?    @map("description")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  parent   Lookup?  @relation("LookupHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Lookup[] @relation("LookupHierarchy")

  assetCategories    Asset[]    @relation("AssetCategory")
  departments        Asset[]    @relation("AssetDepartment")
  locationCategories Location[] @relation("LocationCategory")

  @@unique([siteId, kind, code])
  @@index([siteId])
  @@index([siteId, kind])
  @@index([parentId])
  @@map("lookup")
}

/**
 * -------------------- Locations & Assets --------------------
 */

model Location {
  id               String         @id @default(uuid()) @map("id") @db.Uuid
  siteId           String         @map("site_id") @db.Uuid
  parentLocationId String?        @map("parent_location_id") @db.Uuid
  categoryId       String?        @map("category_id") @db.Uuid // Lookup(kind=LOCATION_CATEGORY)
  name             String         @map("name")
  code             String         @map("code")
  description      String?        @map("description")
  personInChargeId String?        @map("person_in_charge_id") @db.Uuid
  status           LocationStatus @default(ACTIVE) @map("status")
  imageUrl         String?        @map("image_url")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  parentLocation Location?  @relation("LocationHierarchy", fields: [parentLocationId], references: [id], onDelete: Cascade)
  subLocations   Location[] @relation("LocationHierarchy")

  category       Lookup? @relation("LocationCategory", fields: [categoryId], references: [id])
  personInCharge User?   @relation("LocationPersonInCharge", fields: [personInChargeId], references: [id])

  assets Asset[]

  @@unique([siteId, code])
  @@index([siteId])
  @@index([parentLocationId])
  @@index([categoryId])
  @@index([personInChargeId])
  @@map("location")
}

model Asset {
  id         String @id @default(uuid()) @map("id") @db.Uuid
  siteId     String @map("site_id") @db.Uuid
  locationId String @map("location_id") @db.Uuid

  name String @map("name")
  code String @map("code")

  assetCategoryId String  @map("asset_category_id") @db.Uuid // Lookup(kind=ASSET_CATEGORY)
  departmentId    String? @map("department_id") @db.Uuid // Lookup(kind=DEPARTMENT)

  parentAssetId      String?     @map("parent_asset_id") @db.Uuid
  serialNumber       String?     @map("serial_number")
  make               String?     @map("make")
  model              String?     @map("model")
  purchaseDate       DateTime?   @map("purchase_date")
  purchasePrice      Decimal?    @map("purchase_price") @db.Decimal(15, 2)
  warrantyExpiryDate DateTime?   @map("warranty_expiry_date")
  personInChargeId   String?     @map("person_in_charge_id") @db.Uuid
  status             AssetStatus @default(ACTIVE) @map("status")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  site     Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  assetCategory Lookup  @relation("AssetCategory", fields: [assetCategoryId], references: [id], onDelete: Cascade)
  department    Lookup? @relation("AssetDepartment", fields: [departmentId], references: [id])

  parentAsset Asset?  @relation("AssetHierarchy", fields: [parentAssetId], references: [id])
  childAssets Asset[] @relation("AssetHierarchy")

  personInCharge User? @relation("AssetPersonInCharge", fields: [personInChargeId], references: [id])

  meterReadings MeterReading[]
  pmSchedules   PMSchedule[]
  workOrders    WorkOrder[]

  @@unique([siteId, code])
  @@index([siteId])
  @@index([locationId])
  @@index([assetCategoryId])
  @@index([departmentId])
  @@index([parentAssetId])
  @@index([serialNumber])
  @@index([status])
  @@map("asset")
}

/**
 * -------------------- Preventive Maintenance --------------------
 */

model PMSchedule {
  id                String            @id @default(uuid()) @map("id") @db.Uuid
  siteId            String            @map("site_id") @db.Uuid
  code              String            @map("code")
  assetId           String            @map("asset_id") @db.Uuid
  priority          WorkOrderPriority @default(MEDIUM) @map("priority")
  description       String            @map("description")
  frequencyType     FrequencyType     @map("frequency_type")
  frequencyValue    Int               @map("frequency_value")
  isActive          Boolean           @default(true) @map("is_active")
  nextDueDate       DateTime?         @map("next_due_date")
  lastGeneratedDate DateTime?         @map("last_generated_date")
  lastCompletedDate DateTime?         @map("last_completed_date")
  estimateHours     Float?            @map("estimate_hours")
  instructions      String?           @map("instructions")
  autoGenerate      Boolean           @default(true) @map("auto_generate")

  // planning / notification windows
  warningDays Int @default(7) @map("warning_days")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  site  Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  workOrders WorkOrder[]

  @@unique([siteId, code])
  @@index([siteId])
  @@index([assetId])
  @@index([nextDueDate])
  @@index([isActive])
  @@map("pm_schedule")
}

/**
 * -------------------- Work Orders --------------------
 */

model WorkOrder {
  id      String @id @default(uuid()) @map("id") @db.Uuid
  siteId  String @map("site_id") @db.Uuid
  code    String @map("code")
  assetId String @map("asset_id") @db.Uuid

  status   WorkOrderStatus   @default(OPEN) @map("status")
  priority WorkOrderPriority @default(MEDIUM) @map("priority")
  type     WorkOrderType     @default(CORRECTIVE) @map("type")

  description String @map("description")

  assignId String? @map("assign_id") @db.Uuid

  cost              Decimal?  @map("cost") @db.Decimal(15, 2)
  expectedStartDate DateTime? @map("expected_start_date")
  expectedEndDate   DateTime? @map("expected_end_date")
  estimateTimeHours Float?    @map("estimate_time_hours")
  actualStartDate   DateTime? @map("actual_start_date")
  actualEndDate     DateTime? @map("actual_end_date")
  actualTimeHours   Float?    @map("actual_time_hours")
  completionNote    String?   @map("completion_note")
  pmScheduleId      String?   @map("pm_schedule_id") @db.Uuid

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  site  Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  assignedUser User?       @relation("WorkOrderAssignedUser", fields: [assignId], references: [id])
  pmSchedule   PMSchedule? @relation(fields: [pmScheduleId], references: [id])

  tasks       WOTask[]
  notes       WorkOrderNote[]
  assignments WorkOrderAssignment[]

  @@unique([siteId, code])
  @@index([siteId])
  @@index([assetId])
  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([pmScheduleId])
  @@index([assignId])
  @@map("work_order")
}

model WorkOrderNote {
  id          String @id @default(uuid()) @map("id") @db.Uuid
  workOrderId String @map("work_order_id") @db.Uuid
  note        String @map("note")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_note")
}

model WorkOrderAssignment {
  id          String @id @default(uuid()) @map("id") @db.Uuid
  workOrderId String @map("work_order_id") @db.Uuid
  userId      String @map("user_id") @db.Uuid

  assignedBy  String    @map("assigned_by") @db.Uuid
  assignedAt  DateTime  @map("assigned_at")
  removedById String?   @map("removed_by_id") @db.Uuid
  removedAt   DateTime? @map("removed_at")

  isActive Boolean @default(true) @map("is_active")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User      @relation("WorkOrderAssignmentUser", fields: [userId], references: [id])

  assignedByUser User  @relation("WorkOrderAssignedBy", fields: [assignedBy], references: [id])
  removedByUser  User? @relation("WorkOrderRemovedBy", fields: [removedById], references: [id])

  @@index([workOrderId])
  @@index([userId])
  @@index([assignedBy])
  @@index([isActive])
  @@map("work_order_assignment")
}

model WOTask {
  id   String @id @default(uuid()) @map("id") @db.Uuid
  woId String @map("wo_id") @db.Uuid

  taskNumber  Int     @map("task_number")
  code        String  @map("code")
  description String? @map("description")

  assigneeUserId String? @map("assignee_user_id") @db.Uuid

  expectedStartDate DateTime?      @map("expected_start_date")
  expectedEndDate   DateTime?      @map("expected_end_date")
  estimateTimeHours Float?         @map("estimate_time_hours")
  actualStartDate   DateTime?      @map("actual_start_date")
  actualEndDate     DateTime?      @map("actual_end_date")
  actualTimeHours   Float?         @map("actual_time_hours")
  status            WorkTaskStatus @default(ASSIGNED) @map("status")
  completionNote    String?        @map("completion_note")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workOrder    WorkOrder @relation(fields: [woId], references: [id], onDelete: Cascade)
  assigneeUser User?     @relation("WorkOrderTaskAssignee", fields: [assigneeUserId], references: [id])

  @@unique([woId, taskNumber])
  @@index([woId])
  @@index([taskNumber])
  @@index([status])
  @@index([code])
  @@index([assigneeUserId])
  @@map("wo_task")
}

/**
 * -------------------- Meter Readings --------------------
 */

model MeterReading {
  id           String   @id @default(uuid()) @map("id") @db.Uuid
  assetId      String   @map("asset_id") @db.Uuid
  readingValue Float    @map("reading_value")
  unit         String   @map("unit")
  readingDate  DateTime @map("reading_date")
  readBy       String   @map("read_by") @db.Uuid

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user  User  @relation("MeterReadingReadBy", fields: [readBy], references: [id])

  @@index([assetId])
  @@index([readingDate])
  @@index([readBy])
  @@map("meter_reading")
}

/**
 * -------------------- Notifications --------------------
 */

model NotificationEvent {
  id        String  @id @default(uuid()) @map("id") @db.Uuid
  siteId    String  @map("site_id") @db.Uuid
  eventName String  @map("event_name")
  userId    String? @map("user_id") @db.Uuid

  channels  Json? @map("channels")
  recipient Json? @map("recipient")
  payload   Json? @map("payload")
  metadata  Json? @map("metadata")

  status        NotificationStatus @default(PENDING) @map("status")
  statusMessage String?            @map("status_message")
  attempts      Int                @default(0) @map("attempts")
  occurredAt    DateTime           @map("occurred_at")
  sentAt        DateTime?          @map("sent_at")
  failedAt      DateTime?          @map("failed_at")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  site Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  deliveryAttempts NotificationAttempt[]

  @@index([siteId])
  @@index([userId])
  @@index([eventName])
  @@index([status])
  @@index([occurredAt])
  @@index([siteId, eventName, occurredAt])
  @@index([siteId, userId])
  @@index([siteId, status])
  @@map("notification_event")
}

model NotificationAttempt {
  id           String                    @id @default(uuid()) @map("id") @db.Uuid
  eventId      String                    @map("event_id") @db.Uuid
  status       NotificationAttemptStatus @map("status")
  channel      NotificationChannel?      @map("channel")
  responseCode String?                   @map("response_code")
  responseBody Json?                     @map("response_body")
  errorMessage String?                   @map("error_message")
  providerId   String?                   @map("provider_id")
  occurredAt   DateTime                  @default(now()) @map("occurred_at")

  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  event NotificationEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
  @@index([occurredAt])
  @@map("notification_attempt")
}
